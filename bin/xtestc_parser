#!/bin/sh
# -*- coding: utf-8-unix -*-

DIR="$(cd "$(dirname "${0}")"; pwd)"
TOP_DIR="$(cd "$(dirname "${DIR}")"; pwd)"
BIN_DIR="${TOP_DIR}/bin"
LIB_DIR="${TOP_DIR}/lib"
TEST_DIR="${TOP_DIR}/test"

PATH="${PATH}:${BIN_DIR}:${LIB_DIR}"

. parsec.sh

p_cat ()
{
    many anyChar eof show
}

cyan ()
{
    printf "\33[36m%s\33[39m" "${1}"
}

yellow ()
{
    printf "\33[33m%s\33[39m" "${1}"
}

p_cat_n ()
{
    local tag name
    until try eof ; do
	printf '%6d  ' "${__line__}"
	try 'char @' && {
	    identifier as tag
	    many1 space
	    quoted_string as name
	    many space
	    show "$(cyan "@${tag}") $(yellow "${name}") "
    	    try newline show
	} || line show
    done
}

xtestc_parser ()
{
    parse "${1}" p_cat_n
}

# --- main ---
[ $# -ne 0 ] || exit 1
y=;
for x in "${@}"; do
    if [ ':-' = ":${x}" ] ; then
	[ ! "${y}" ] || {
	    echo "Too much stdin(-)" >&2
	    exit 1
	}
	y=1
    else
	[ -f "${x}" ] || {
	    echo "No such file - '${x}'" >&2
	    exit 1
	}
    fi
done
while [ $# -gt 0 ] ; do
    if [ ':-' = ":${1}" ] ; then
	xtestc_parser '-'
    else
	xtestc_parser "${1}" < "${1}"
    fi
    shift
done
